<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Markerless AR with Gestures</title>

  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <!-- AR hit-test component -->
  <script src="https://unpkg.com/aframe-ar-hit-test-component@^1.0.0/dist/aframe-ar-hit-test-component.min.js"></script>
  <!-- Gesture detector & handler -->
  <script src="https://unpkg.com/aframe-gesture-detector@^1.0.0/dist/aframe-gesture-detector.min.js"></script>
  <script src="https://unpkg.com/aframe-gesture-handler@^1.0.0/dist/aframe-gesture-handler.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    .loader {
      position: absolute; top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 1.2em; z-index: 9999;
    }
    .reminder, #enter-ar {
      position: absolute;
      bottom: 20px; left:50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff; padding: 10px 20px;
      border: none; border-radius: 4px; font-size: 0.9em;
      z-index: 10000;
    }
    .reminder { display: none; animation: flash 1s infinite; }
    @keyframes flash {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    #enter-ar { cursor: pointer; }
  </style>
</head>
<body>
  <div class="loader">Initializing ARâ€¦</div>
  <div class="reminder">Move your device to scan for surfaces</div>
  <button id="enter-ar">Enter AR</button>

  <a-scene
    embedded
    renderer="logarithmicDepthBuffer: true"
    webxr="optionalFeatures: hit-test; requiredFeatures: local-floor;"
    ar-hit-test="target: #reticle;"
    gesture-detector
    loading-screen="enabled: false"
  >
    <!-- Reticle for placement -->
    <a-entity
      id="reticle"
      geometry="primitive: ring; radiusInner: 0.03; radiusOuter: 0.04;"
      material="shader: flat; opacity: 0.8;"
      visible="false"
    ></a-entity>

    <!-- Your GLB model, hidden until placed -->
    <a-entity
      id="my-model"
      gltf-model="url(assets/SamIp_business_card.glb)"
      visible="false"
      scale="0.3 0.3 0.3"
      gesture-handler="enabled: true; rotate: true; scale: true;"
    ></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const enterAR = document.getElementById('enter-ar');
    const sceneEl = document.querySelector('a-scene');
    const loader = document.querySelector('.loader');
    const reminder = document.querySelector('.reminder');
    const reticle = document.getElementById('reticle');
    const model = document.getElementById('my-model');

    // Hide AR button if WebXR AR not supported
    navigator.xr?.isSessionSupported('immersive-ar').then((supported) => {
      if (!supported) {
        enterAR.textContent = 'AR Not Supported';
        enterAR.disabled = true;
      }
    });

    enterAR.addEventListener('click', async () => {
      try {
        const session = await navigator.xr.requestSession('immersive-ar', {
          optionalFeatures: ['hit-test', 'dom-overlay'],
          requiredFeatures: ['local-floor'],
          domOverlay: { root: document.body }
        });
        sceneEl.renderer.xr.setSession(session);
        enterAR.style.display = 'none';
      } catch (err) {
        console.error('Failed to start AR session:', err);
        enterAR.textContent = 'Failed to Enter AR';
      }
    });

    // A-Frame loaded
    sceneEl.addEventListener('loaded', () => {
      loader.style.display = 'none';
      reminder.style.display = 'block';
    });

    // When a surface is found
    sceneEl.addEventListener('reticlePlaced', (evt) => {
      const { position, rotation } = evt.detail;
      reticle.object3D.position.copy(position);
      reticle.object3D.quaternion.copy(rotation);
      reticle.setAttribute('visible', true);
      reminder.style.display = 'none';
    });

    // If surface lost
    sceneEl.addEventListener('hitLost', () => {
      reticle.setAttribute('visible', false);
      reminder.style.display = 'block';
    });

    // On tap, place or move the model
    sceneEl.addEventListener('select', () => {
      model.object3D.position.copy(reticle.object3D.position);
      model.object3D.quaternion.copy(reticle.object3D.quaternion);
      model.setAttribute('visible', true);
    });
  </script>
</body>
</html>
